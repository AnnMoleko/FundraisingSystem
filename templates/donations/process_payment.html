{% extends 'base.html' %}
{% load static %}

{% block title %}Complete Payment - EduFund{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();
    
    // Create card element
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
        },
    });
    
    cardElement.mount('#card-element');
    
    // Handle form submission
    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit-payment');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');
    const cardErrors = document.getElementById('card-errors');
    
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        // Disable submit button and show loading
        submitButton.disabled = true;
        buttonText.style.display = 'none';
        spinner.style.display = 'inline-block';
        
        try {
            // Create payment intent on server
            const response = await fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success && result.client_secret) {
                // Confirm payment with Stripe
                const {error} = await stripe.confirmCardPayment(result.client_secret, {
                    payment_method: {
                        card: cardElement,
                    }
                });
                
                if (error) {
                    // Show error to customer
                    cardErrors.textContent = error.message;
                    cardErrors.style.display = 'block';
                } else {
                    // Payment succeeded, redirect to success page
                    window.location.href = '{% url "donation_success" donation.id %}';
                }
            } else {
                cardErrors.textContent = result.error || 'Payment failed. Please try again.';
                cardErrors.style.display = 'block';
            }
        } catch (error) {
            cardErrors.textContent = 'Network error. Please try again.';
            cardErrors.style.display = 'block';
        }
        
        // Re-enable submit button
        submitButton.disabled = false;
        buttonText.style.display = 'inline';
        spinner.style.display = 'none';
    });
    
    // Handle real-time validation errors from the card Element
    cardElement.on('change', ({error}) => {
        if (error) {
            cardErrors.textContent = error.message;
            cardErrors.style.display = 'block';
        } else {
            cardErrors.style.display = 'none';
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12">
    <div class="max-w-xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-gradient-to-br from-[#3B38A0] to-[#1A2A80] text-white p-8 md:p-10 text-center">
            <h1 class="text-3xl font-extrabold mb-2">Complete Your Payment</h1>
            <p class="opacity-90">Supporting {{ donation.campaign.title }}</p>
            <div class="text-4xl font-bold mt-4">R{{ total_amount|floatformat:2 }}</div>
        </div>
        
        <div class="p-8 md:p-10">
            <div class="bg-gray-50 border border-gray-200 rounded-xl p-5 mb-8">
                <h3 class="text-lg font-bold text-gray-900 mb-3">Payment Summary</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Donation Amount:</span>
                        <span class="font-medium text-gray-800">R{{ donation.amount|floatformat:2 }}</span>
                    </div>
                    {% if donation.processing_fee %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Processing Fee:</span>
                        <span class="font-medium text-gray-800">R{{ donation.processing_fee|floatformat:2 }}</span>
                    </div>
                    {% endif %}
                    <div class="border-t border-gray-200 pt-3 flex justify-between font-bold text-base">
                        <span>Total:</span>
                        <span>R{{ total_amount|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
            
            {% if donation.payment_method == 'stripe' or donation.payment_method == 'credit_card' or donation.payment_method == 'visa' or donation.payment_method == 'mastercard' or donation.payment_method == 'amex' or donation.payment_method == 'discover' %}
                <div id="stripe-payment-form">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        {% if donation.payment_method == 'visa' %}
                            Visa Payment
                        {% elif donation.payment_method == 'mastercard' %}
                            MasterCard Payment
                        {% elif donation.payment_method == 'amex' %}
                            American Express Payment
                        {% elif donation.payment_method == 'discover' %}
                            Discover Payment
                        {% else %}
                            Credit/Debit Card Payment
                        {% endif %}
                    </h3>
                    
                    <form id="payment-form">
                        {% csrf_token %}
                        <div id="card-element" class="p-4 border border-gray-300 rounded-xl bg-white focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-shadow">
                            </div>
                        
                        <div id="card-errors" class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl mt-4" style="display: none;"></div>
                        
                        <button id="submit-payment" class="w-full mt-6 inline-flex items-center justify-center px-6 py-3 border border-transparent rounded-full shadow-lg text-base font-medium text-white bg-gradient-to-r from-[#5A67D8] to-[#2B6D6D] hover:bg-opacity-90 transition-colors duration-200" disabled>
                            <span id="button-text">Complete Payment</span>
                            <div id="spinner" class="inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" style="display: none;"></div>
                        </button>
                    </form>
                </div>
            {% elif donation.payment_method == 'mobile_money' or donation.payment_method == 'bank_transfer' %}
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">{{ donation.get_payment_method_display }}</h3>
                    
                    {% if donation.payment_method == 'mobile_money' %}
                        <div class="bg-[#F0ECFA] p-6 rounded-xl mb-6">
                            <h4 class="font-bold text-[#5A67D8] mb-3">
                                <span class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM6 9a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1A.5.5 0 006 9zm2.5 0a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1a.5.5 0 00-.5-.5zm4 0a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1a.5.5 0 00-.5-.5zm-2 0a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1a.5.5 0 00-.5-.5zM14 9a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1A.5.5 0 0014 9z"></path><path fill-rule="evenodd" d="M10 4a6 6 0 100 12 6 6 0 000-12zM6 9.5a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1a.5.5 0 00-.5-.5z" clip-rule="evenodd"></path></svg>
                                    Mobile Money Instructions
                                </span>
                            </h4>
                            <ol class="list-decimal list-inside text-sm text-[#5A67D8] space-y-1">
                                <li>Dial *150*00# on your mobile phone</li>
                                <li>Select "Send Money"</li>
                                <li>Enter recipient number: <strong class="text-gray-900">+1234567890</strong></li>
                                <li>Enter amount: <strong class="text-gray-900">R{{ total_amount|floatformat:2 }}</strong></li>
                                <li>Reference: <strong class="text-gray-900">{{ donation.id }}</strong></li>
                                <li>Confirm the transaction</li>
                            </ol>
                        </div>
                    {% elif donation.payment_method == 'bank_transfer' %}
                        <div class="bg-[#EAF6F6] p-6 rounded-xl mb-6">
                            <h4 class="font-bold text-[#2B6D6D] mb-3">
                                <span class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM6 9a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1A.5.5 0 006 9zm2.5 0a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1a.5.5 0 00-.5-.5zm4 0a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1a.5.5 0 00-.5-.5zm-2 0a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1a.5.5 0 00-.5-.5zM14 9a.5.5 0 00-.5.5v1a.5.5 0 001 0v-1A.5.5 0 0014 9z"></path></svg>
                                    Bank Transfer Details
                                </span>
                            </h4>
                            <div class="text-sm text-[#2B6D6D] space-y-2">
                                <p><strong>Bank:</strong> EduFund Bank</p>
                                <p><strong>Account Name:</strong> EduFund Foundation</p>
                                <p><strong>Account Number:</strong> 1234567890</p>
                                <p><strong>Routing Number:</strong> 021000021</p>
                                <p><strong>Amount:</strong> R{{ total_amount|floatformat:2 }}</p>
                                <p><strong>Reference:</strong> {{ donation.id }}</p>
                            </div>
                        </div>
                    {% endif %}
                    
                    <form method="post">
                        {% csrf_token %}
                        <button type="submit" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent rounded-full shadow-sm text-base font-medium text-white bg-[#3B38A0] hover:bg-opacity-90 transition-colors duration-200">
                            I have completed the payment
                        </button>
                    </form>
                    
                    <p class="text-center text-xs text-gray-500 mt-4">
                        Your donation will be verified within 24 hours. You'll receive a confirmation email once it's verified.
                    </p>
                </div>
            {% endif %}
            
            <div class="text-center mt-6">
                <a href="{% url 'campaign_detail' donation.campaign.id %}" class="text-sm text-gray-500 hover:text-[#3B38A0] hover:underline transition-colors duration-200">
                    Cancel and return to campaign
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}